<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>/비트/외래 통계 자동 계산 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; overflow-x: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .warn { color: red; font-weight: bold; margin-top: 10px; }
    .input-section { margin: 20px 0; }
    .group-0 { background-color: #dcedc8; font-weight: bold; }
    .group-1 { background-color: #fff8e1; }
    .group-2 { background-color: #f1f8e9; }
    .group-3 { background-color: #fce4ec; }
    .group-4 { background-color: #ede7f6; }
    .group-5 { background-color: #e3f2fd; }
  </style>
</head>
<body>
  <h1>/비트/외래 통계 자동 계산기</h1>

  <div class="input-section">
    <label>✔️ 특정 키워드(예: PT만)를 입력하세요:</label><br>
    <input type="text" id="keywordInput" placeholder="예: PT만" style="width: 200px; margin-top: 5px;" />
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    // (기존 상단 로직 유지)

    // ... (이전 코드 생략) ...

      let 통계 = [];

      // ✅ 병원 전체 통계 먼저 추가
      연령순서.forEach(연령대 => {
        const 그룹 = 연령대 === "전체" ? df : df.filter(r => getAgeGroup(r[headerMap['연령']]) === 연령대);
        if (그룹.length > 0) {
          통계.push(countStats(그룹, `병원전체 / ${연령대}`));
        }
      });

      // ✅ 진료과별 통계 추가
      진료실목록.forEach((진료과, idx) => {
        const 진료과데이터 = df.filter(r => (r[headerMap['진료과']] || '기타') === 진료과);
        연령순서.forEach(연령대 => {
          const 그룹 = 연령대 === "전체" ? 진료과데이터 : 진료과데이터.filter(r => getAgeGroup(r[headerMap['연령']]) === 연령대);
          if (그룹.length > 0) {
            통계.push(countStats(그룹, `${진료과} / ${연령대}`));
          }
        });
      });

      const keys = ["진료실", "연령대", ...Object.keys(통계[0]).filter(k => !["진료실", "연령대"].includes(k))];
      let html = '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';

      // ✅ 병원 전체 구분 먼저 렌더링
      const 전체병원 = 통계.filter(r => r['진료실'] === "병원전체");
      html += 전체병원.map((row, j) => {
        let rowHtml = '<tr class="group-0">';
        if (j === 0) rowHtml += `<td rowspan="${전체병원.length}">${row['진료실']}</td>`;
        rowHtml += `<td>${row['연령대']}</td>`;
        keys.slice(2).forEach(k => rowHtml += `<td>${row[k]}</td>`);
        rowHtml += '</tr>';
        return rowHtml;
      }).join('');

      // ✅ 나머지 진료실 렌더링
      let groupIndex = 0;
      const 병원전체제외 = 통계.filter(r => r['진료실'] !== "병원전체");
      let currentGroup = "";
      for (let i = 0; i < 병원전체제외.length;) {
        const groupName = 병원전체제외[i]['진료실'];
        const groupRows = 병원전체제외.filter(r => r['진료실'] === groupName);
        groupIndex++;
        const groupClass = `group-${groupIndex % 5 || 5}`;
        groupRows.forEach((row, j) => {
          html += '<tr class="' + groupClass + '">';
          if (j === 0) html += `<td rowspan="${groupRows.length}">${groupName}</td>`;
          html += `<td>${row['연령대']}</td>`;
          keys.slice(2).forEach(k => html += `<td>${row[k]}</td>`);
          html += '</tr>';
        });
        i += groupRows.length;
      }

      html += '</tbody></table>';
      document.getElementById('output').innerHTML = html;
  </script>
</body>
</html>
