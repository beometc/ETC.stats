<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>/비트/외래 통계 자동 계산 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; overflow-x: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .warn { color: red; font-weight: bold; margin-top: 10px; }
    .input-section { margin: 20px 0; }
    .group-0 { background-color: #dcedc8; font-weight: bold; }
    .group-1 { background-color: #fff8e1; }
    .group-2 { background-color: #f1f8e9; }
    .group-3 { background-color: #fce4ec; }
    .group-4 { background-color: #ede7f6; }
    .group-5 { background-color: #e3f2fd; }
  </style>
</head>
<body>
  <h1>/비트/외래 통계 자동 계산기</h1>

  <div class="input-section">
    <label>✔️ 특정 키워드(예: PT만)를 입력하세요:</label><br>
    <input type="text" id="keywordInput" placeholder="예: PT만" style="width: 200px; margin-top: 5px;" />
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    function getAgeGroup(value) {
      if (!value) return "미확인";
      const match = value.match(/(\d{1,3})세/);
      if (!match) return "미확인";
      const age = parseInt(match[1]);
      if (age <= 19) return "0~10대";
      if (age <= 29) return "20대";
      if (age <= 39) return "30대";
      if (age <= 49) return "40대";
      if (age <= 64) return "50대~64세";
      return "65세이상";
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
      const reader = new FileReader();

      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        const headers = rows[0];
        const dataRows = rows.slice(1);

        const 연령Col = headers.find(h => h.includes("연령"));
        const 진료실Col = headers.find(h => h.includes("진료실") || h.includes("진료과"));

        const groupMap = {};
        dataRows.forEach(row => {
          const 연령 = getAgeGroup(row[headers.indexOf(연령Col)]);
          const 진료실 = row[headers.indexOf(진료실Col)] || "기타";

          const key = `${진료실}/${연령}`;
          if (!groupMap[key]) groupMap[key] = [];
          groupMap[key].push(row);

          const 전체Key = `${진료실}/전체`;
          if (!groupMap[전체Key]) groupMap[전체Key] = [];
          groupMap[전체Key].push(row);

          const 병원전체Key = `병원전체/${연령}`;
          if (!groupMap[병원전체Key]) groupMap[병원전체Key] = [];
          groupMap[병원전체Key].push(row);

          const 병원전체전체Key = `병원전체/전체`;
          if (!groupMap[병원전체전체Key]) groupMap[병원전체전체Key] = [];
          groupMap[병원전체전체Key].push(row);
        });

        const 연령순서 = ["전체", "0~10대", "20대", "30대", "40대", "50대~64세", "65세이상"];
        const 통계 = [];

        const 진료실들 = [...new Set(Object.keys(groupMap).map(k => k.split('/')[0]))];

        진료실들.forEach((진료실, i) => {
          연령순서.forEach(연령대 => {
            const key = `${진료실}/${연령대}`;
            if (groupMap[key]) {
              const rows = groupMap[key];
              통계.push({
                "진료실": 진료실,
                "연령대": 연령대,
                "총환자수": rows.length,
                "초진환자수": 0,
                "재진환자수": 0,
                "초진 주사 처방률": "0%",
                "초진주사 갯수": 0,
                "초진 주사환자 재진율": "0%",
                "초진주사환자 평균 주사횟수": 0,
                "초진 주사환자 평균내원횟수": 0,
                "초진평균내원횟수": 0,
                "초진 재내원율": "0%",
                "1회 내원 비율": "0%",
                "2회 내원 비율": "0%",
                "3회 내원 비율": "0%",
                "4회 내원 비율": "0%",
                "5회 이상 내원 비율": "0%",
                "특정 키워드 포함 메모 수": 0
              });
            }
          });
        });

        const keys = Object.keys(통계[0]);
        let html = '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';

        let groupIndex = 0;
        const grouped = {};
        통계.forEach(row => {
          const g = row['진료실'];
          if (!grouped[g]) grouped[g] = [];
          grouped[g].push(row);
        });

        Object.entries(grouped).forEach(([진료실, rows], idx) => {
          const groupClass = 진료실 === "병원전체" ? 'group-0' : `group-${(idx % 5) + 1}`;
          rows.forEach((row, i) => {
            html += '<tr class="' + groupClass + '">';
            if (i === 0) html += `<td rowspan="${rows.length}">${진료실}</td>`;
            html += `<td>${row['연령대']}</td>`;
            keys.slice(2).forEach(k => html += `<td>${row[k]}</td>`);
            html += '</tr>';
          });
        });

        html += '</tbody></table>';
        document.getElementById('output').innerHTML = html;
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
