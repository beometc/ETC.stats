<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>/비트/외래 통계 자동 계산 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; overflow-x: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .warn { color: red; font-weight: bold; margin-top: 10px; }
    .input-section { margin: 20px 0; }
    tbody tr.whole { background-color: #eaf2f8; }
    tbody tr.room1 { background-color: #fef9e7; }
    tbody tr.room2 { background-color: #e8f8f5; }
    tbody tr.room3 { background-color: #fbeee6; }
    tbody tr.room4 { background-color: #f9ebea; }
    tbody tr.room5 { background-color: #f5eef8; }
  </style>
</head>
<body>
  <h1>/비트/외래 통계 자동 계산기</h1>
  <div class="input-section">
    <label>✔️ 특정 키워드(예: PT만)를 입력하세요:</label><br>
    <input type="text" id="keywordInput" placeholder="예: PT만" style="width: 200px; margin-top: 5px;" />
  </div>
  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    const AGE_ORDER = ["0~10대", "20대", "30대", "40대", "50대~64세", "65세이상", "전체"];

    function sortResult(a, b) {
      const aGroup = a["구분"];
      const bGroup = b["구분"];
      if (aGroup !== bGroup) return aGroup.localeCompare(bGroup);
      const aAge = a["연령대"];
      const bAge = b["연령대"];
      return AGE_ORDER.indexOf(aAge) - AGE_ORDER.indexOf(bAge);
    }

    function renderTable(result) {
      result.sort(sortResult);
      const keys = Object.keys(result[0] || {}).filter(k => k !== '구분' && k !== '연령대');
      if (keys.length === 0) {
        document.getElementById('warning').innerText = '❗ 통계 데이터를 생성할 수 없습니다. 열 이름을 확인하세요.';
        return;
      }

      let html = '<table><thead><tr><th>구분</th><th>연령대</th>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
      let prevGroup = null;
      let groupRows = {};
      result.forEach(row => {
        groupRows[row["구분"]] = (groupRows[row["구분"]] || 0) + 1;
      });

      result.forEach((row) => {
        const className = row["구분"].startsWith("전체") ? "whole" :
                          row["구분"].startsWith("1진료실") ? "room1" :
                          row["구분"].startsWith("2진료실") ? "room2" :
                          row["구분"].startsWith("3진료실") ? "room3" :
                          row["구분"].startsWith("4진료실") ? "room4" :
                          row["구분"].startsWith("5진료실") ? "room5" : "";

        html += `<tr class="${className}">`;
        if (row["구분"] !== prevGroup) {
          html += `<td rowspan="${groupRows[row["구분"]]}">${row["구분"]}</td>`;
          prevGroup = row["구분"];
        }
        html += `<td>${row["연령대"]}</td>` + keys.map(k => `<td>${row[k]}</td>`).join('') + '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('output').innerHTML = html;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
      const reader = new FileReader();
      const isCSV = file.name.endsWith('.csv');

      reader.onload = function(e) {
        let rawData = [];
        if (isCSV) {
          const csv = e.target.result;
          const rows = csv.split(/\r?\n/).map(row => row.split(','));
          rawData = rows;
          process(rawData, keyword);
        } else {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          workbook.SheetNames.forEach(sheet => {
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], { header: 1, defval: "" });
            rawData = rawData.concat(sheetData);
          });
          process(rawData, keyword);
        }
      };
      if (isCSV) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
