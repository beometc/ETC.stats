<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>/비트/외래 통계 자동 계산 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; overflow-x: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .warn { color: red; font-weight: bold; margin-top: 10px; }
    .input-section { margin: 20px 0; }
    .전체 { background-color: #e0e0e0; }
    .진료실1 { background-color: #d0e9ff; }
    .진료실2 { background-color: #d0f5d8; }
    .진료실3 { background-color: #fff5cc; }
    .진료실4 { background-color: #ffe0b3; }
    .진료실5 { background-color: #f0d9ff; }
  </style>
</head>
<body>
  <h1>/비트/외래 통계 자동 계산기</h1>

  <div class="input-section">
    <label>✔️ 특정 키워드(예: PT만)를 입력하세요:</label><br>
    <input type="text" id="keywordInput" placeholder="예: PT만" style="width: 200px; margin-top: 5px;" />
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    function extractAge(sa) {
      const match = typeof sa === 'string' ? sa.match(/(\d{1,3})세/) : null;
      return match ? parseInt(match[1]) : null;
    }

    function getAgeGroup(age) {
      if (age === null) return "미상";
      if (age <= 19) return "0~10대";
      if (age <= 29) return "20대";
      if (age <= 39) return "30대";
      if (age <= 49) return "40대";
      if (age <= 64) return "50~64세";
      return "65세 이상";
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
      const reader = new FileReader();

      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        let allData = [];

        workbook.SheetNames.forEach(sheet => {
          const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], { header: 1, defval: "" });
          allData = allData.concat(rows);
        });

        const headerRow = allData.find(row => row.includes("초/재"));
        const headerIndex = allData.indexOf(headerRow);
        const headers = headerRow;
        const rows = allData.slice(headerIndex + 1);

        const colMap = {};
        headers.forEach((col, i) => {
          const lower = col.toString().toLowerCase();
          if (lower.includes("초") && lower.includes("재")) colMap.초재 = i;
          if (lower.includes("차트")) colMap.챠트번호 = i;
          if (lower.includes("진료") && lower.includes("과")) colMap.진료과 = i;
          if (lower.includes("마취")) colMap.마취 = i;
          if (lower.includes("접수") && lower.includes("메모")) colMap.접수메모 = i;
          if (lower.includes("s/a")) colMap.SA = i;
        });

        const df = rows.map(r => {
          const age = extractAge(r[colMap.SA]);
          return {
            초재: r[colMap.초재],
            챠트번호: r[colMap.챠트번호],
            진료과: r[colMap.진료과] || "기타",
            마취: r[colMap.마취],
            접수메모: r[colMap.접수메모],
            연령: age,
            연령대: getAgeGroup(age)
          };
        });

        const 진료실목록 = [...new Set(df.map(r => r.진료과))];
        const 연령대목록 = ["0~10대", "20대", "30대", "40대", "50~64세", "65세 이상"];

        let html = '';
        [...["전체"], ...진료실목록].forEach(진료실 => {
          연령대목록.forEach(연령대 => {
            const sub = 진료실 === "전체" ? df.filter(r => r.연령대 === 연령대) : df.filter(r => r.진료과 === 진료실 && r.연령대 === 연령대);
            const 초진 = sub.filter(r => ["신환", "90일초진"].includes(r.초재));
            const 재진 = sub.filter(r => r.초재 && r.초재.includes("재진"));
            const 총 = sub.length;
            const 주사 = 초진.filter(r => (r.마취 || '').includes('●'));
            const 주사차트 = [...new Set(주사.map(r => r.챠트번호))];
            const 주사기록 = sub.filter(r => 주사차트.includes(r.챠트번호));
            const 평균주사횟수 = 주사기록.length ? (주사기록.length / 주사차트.length).toFixed(1) : 0;
            const 키워드수 = keyword ? sub.filter(r => (r.접수메모 || '').toLowerCase().includes(keyword)).length : "";

            const row = {
              구분: `${진료실} - ${연령대}`,
              초진환자수: [...new Set(초진.map(r => r.챠트번호))].length,
              재진환자수: 재진.length,
              총환자수: 총,
              초진 주사 처방률: 초진.length ? `${Math.round((주사.length / 초진.length) * 100)}%` : '0%',
              초진주사 갯수: 주사.length,
              초진 평균 주사횟수: 평균주사횟수,
              특정 키워드 포함 메모 수: 키워드수
            };

            html += `<table class="${진료실.replace(/[^\w]/g, '')}"><thead><tr>` +
              Object.keys(row).map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody><tr>' +
              Object.values(row).map(v => `<td>${v}</td>`).join('') + '</tr></tbody></table>';
          });
        });

        document.getElementById('output').innerHTML = html;
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
